<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>MyGymProgress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    const initData = tg.initDataUnsafe || {};
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      padding: 16px;
    }
    h2, h3 { margin-top: 0; }
    button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #2563eb;
      color: white;
    }
    select, input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    .card {
      background: #1e293b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>

<!-- –ì–õ–ê–í–ù–ê–Ø -->
<div id="home">
  <h2>üèãÔ∏è MyGymProgress</h2>
  <button onclick="openWorkout()">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
  <button onclick="openHistory()">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</button>
</div>

<!-- –¢–†–ï–ù–ò–†–û–í–ö–ê -->
<div id="workout" style="display:none;">
  <h3>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>

  <select id="muscle" onchange="saveSession()">
    <option>–ì—Ä—É–¥—å</option>
    <option>–°–ø–∏–Ω–∞</option>
    <option>–ù–æ–≥–∏</option>
    <option>–ü–ª–µ—á–∏</option>
    <option>–ë–∏—Ü–µ–ø—Å</option>
    <option>–¢—Ä–∏—Ü–µ–ø—Å</option>
    <option>–ü—Ä–µ—Å—Å</option>
  </select>

  <input id="exercise" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" oninput="saveSession()">

  <div id="sets"></div>

  <button onclick="addSet()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
  <button onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
  <button onclick="goHome()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<!-- –ò–°–¢–û–†–ò–Ø -->
<div id="history" style="display:none;">
  <h3>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
  <div id="historyList"></div>
  <button onclick="goHome()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<script>
  let sets = JSON.parse(localStorage.getItem('current_sets')) || [];

  function hideAll() {
    ['home','workout','history'].forEach(id =>
      document.getElementById(id).style.display = 'none'
    );
  }

  function openWorkout() {
    hideAll();
    document.getElementById('workout').style.display = 'block';
  }

  function openHistory() {
    hideAll();
    document.getElementById('history').style.display = 'block';
    loadHistory();
  }

  function goHome() {
    hideAll();
    document.getElementById('home').style.display = 'block';
  }

  function addSet() {
    const reps = prompt("–ü–æ–≤—Ç–æ—Ä—ã:");
    const weight = prompt("–í–µ—Å:");

    if (!reps || !weight) return;

    sets.push({ reps, weight });
    saveSession();
    renderSets();
  }

  function renderSets() {
    document.getElementById('sets').innerHTML =
      sets.map((s, i) =>
        `<div class="card">–ü–æ–¥—Ö–æ–¥ ${i+1}: ${s.reps} √ó ${s.weight}</div>`
      ).join('');
  }

  function saveWorkout() {
    fetch('/api/log', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        muscle_group: document.getElementById('muscle').value,
        name: document.getElementById('exercise').value,
        sets: sets,
        initData: initData
      })
    })
    .then(r => r.json())
    .then(() => {
      alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      clearSession();
      sets = [];
      renderSets();
      document.getElementById('exercise').value = '';
      goHome();
    });
  }

  function loadHistory() {
    fetch('/api/init', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ initData })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('historyList').innerHTML =
        data.history.length
          ? data.history.map(h =>
              `<div class="card">${h.date}<br>${h.name}<br>–û–±—ä—ë–º: ${h.total}</div>`
            ).join('')
          : '<p>–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>';
    });
  }

  function saveSession() {
    localStorage.setItem('current_sets', JSON.stringify(sets));
    localStorage.setItem('current_muscle', document.getElementById('muscle').value);
    localStorage.setItem('current_exercise', document.getElementById('exercise').value);
  }

  function clearSession() {
    localStorage.removeItem('current_sets');
    localStorage.removeItem('current_muscle');
    localStorage.removeItem('current_exercise');
  }

  function restoreSession() {
    const muscle = localStorage.getItem('current_muscle');
    const exercise = localStorage.getItem('current_exercise');

    if (sets.length || exercise) {
      openWorkout();
      if (muscle) document.getElementById('muscle').value = muscle;
      if (exercise) document.getElementById('exercise').value = exercise;
      renderSets();
    }
  }

  restoreSession();
</script>

</body>
</html>
